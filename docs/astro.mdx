---
title: Astro
description: Install and configure Convex + Better Auth for Astro.
---

<Callout>
  Check out a complete Convex + Better Auth example with Astro in the
  [GitHub repo](https://github.com/ryantamulevicz/convex-better-auth-astro/tree/main/example).
</Callout>

## Installation

<div className="fd-steps">

  <div className="fd-step">
    ### Install packages

    Install Convex, Better Auth, and the Astro helper package.

    <Callout>This setup assumes you have an Astro project with Convex initialized.</Callout>

    ```pnpm
    pnpm add convex@latest @convex-dev/better-auth
    pnpm add better-auth@1.3.27 --save-exact
    pnpm add @ryantamulevicz/convex-better-auth-astro
    ```
  </div>

  <div className="fd-step">
    ### Register the component

    Register the Better Auth component in your Convex project.

    ```ts title="convex/convex.config.ts"
    import { defineApp } from "convex/server";
    import betterAuth from "@convex-dev/better-auth/convex.config";

    const app = defineApp();
    app.use(betterAuth);

    export default app;
    ```
  </div>

  <div className="fd-step">
    ### Configure Better Auth

    Align Better Auth with your Convex domain.

    ```ts title="convex/auth.config.ts"
    export default {
      providers: [
        {
          domain: process.env.CONVEX_SITE_URL,
          applicationID: "convex",
        },
      ],
    };
    ```
  </div>

  <div className="fd-step">
    ### Set environment variables

    Store the Better Auth secret and site URL in Convex.

    ```shell
    npx convex env set BETTER_AUTH_SECRET=$(openssl rand -base64 32)
    ```

    ```shell
    npx convex env set SITE_URL http://localhost:4321
    ```

    Add the Convex defaults generated by `npx convex dev` to `.env.local` so Astro can
    read them.

    ```ini title=".env.local"
    # Deployment used by `npx convex dev`
    CONVEX_DEPLOYMENT=dev:adjective-animal-123 # team: team-name, project: project-name

    PUBLIC_CONVEX_URL=https://adjective-animal-123.convex.cloud
    # Same as PUBLIC_CONVEX_URL but ends in .site
    PUBLIC_CONVEX_SITE_URL=https://adjective-animal-123.convex.site

    # Your local site URL
    SITE_URL=http://localhost:4321
    ```
  </div>

  <div className="fd-step">
    ### Create a Better Auth instance

    Create `convex/auth.ts` so Better Auth can run on Convex.

    ```ts title="convex/auth.ts"
    import { createClient, type GenericCtx } from "@convex-dev/better-auth";
    import { convex } from "@convex-dev/better-auth/plugins";
    import { components } from "./_generated/api";
    import { DataModel } from "./_generated/dataModel";
    import { query } from "./_generated/server";
    import { betterAuth } from "better-auth";

    const siteUrl = process.env.SITE_URL!;

    // The component client has methods needed for integrating Convex with Better Auth,
    // as well as helper methods for general use.
    export const authComponent = createClient<DataModel>(components.betterAuth);

    export const createAuth = (
      ctx: GenericCtx<DataModel>,
      { optionsOnly } = { optionsOnly: false },
    ) => {
      return betterAuth({
        // disable logging when createAuth is called just to generate options.
        // this is not required, but there's a lot of noise in logs without it.
        logger: {
          disabled: optionsOnly,
        },
        baseURL: siteUrl,
        database: authComponent.adapter(ctx),
        // Configure simple, non-verified email/password to get started
        emailAndPassword: {
          enabled: true,
          requireEmailVerification: false,
        },
        plugins: [
          // The Convex plugin is required for Convex compatibility
          convex(),
        ],
      });
    };

    // Example function for getting the current user
    // Feel free to edit, omit, etc.
    export const getCurrentUser = query({
      args: {},
      handler: async (ctx) => {
        return authComponent.getAuthUser(ctx);
      },
    });
    ```
  </div>

  <div className="fd-step">
    ### Mount HTTP handlers

    Register Better Auth routes in Convex.

    ```ts title="convex/http.ts"
    import { httpRouter } from "convex/server";
    import { authComponent, createAuth } from "./auth";

    const http = httpRouter();
    authComponent.registerRoutes(http, createAuth);

    export default http;
    ```
  </div>

  <div className="fd-step">
    ### Proxy auth requests

    Add an Astro API route to forward Better Auth traffic to Convex.

    ```ts title="src/pages/api/auth/[...all]/route.ts"
    import { astroHandler } from "@ryantamulevicz/convex-better-auth-astro";
    import type { APIRoute } from "astro";

    const convexSiteUrl = import.meta.env.PUBLIC_CONVEX_SITE_URL;
    const handler = astroHandler(convexSiteUrl ? { convexSiteUrl } : undefined);

    export const prerender = false;

    export const ALL: APIRoute = async (context) => {
      return handler(context);
    };
    ```
  </div>
</div>

### You're done!

You're now ready to start using Better Auth with Convex in Astro.

## Client setup

Pick the client-side library you plan to use and follow the matching steps.

<div className="fd-steps">

  <div className="fd-step">
    ### React (optional)

    Create helpers so React islands can talk to Better Auth and Convex.

    ```ts title="src/lib/auth-client.ts"
    import { createAuthClient } from "better-auth/react";
    import { convexClient } from "@convex-dev/better-auth/client/plugins";

    export const authClient = createAuthClient({
      plugins: [convexClient()],
    });
    ```

    ```tsx title="src/lib/react-convex.tsx"
    import { ConvexBetterAuthProvider } from "@convex-dev/better-auth/react";
    import { ConvexReactClient } from "convex/react";
    import type { FunctionComponent, JSX } from "react";
    import { authClient } from "./auth-client";

    // Initialized once so all components share the same client.
    const convex = new ConvexReactClient(
      import.meta.env.PUBLIC_CONVEX_URL as string,
      {
        // Optionally pause queries until the user is authenticated
        expectAuth: true,
      },
    );

    export function withConvexProvider<Props extends JSX.IntrinsicAttributes>(
      Component: FunctionComponent<Props>,
    ) {
      return function WithConvexProvider(props: Props) {
        return (
          <ConvexBetterAuthProvider client={convex} authClient={authClient}>
            <Component {...props} />
          </ConvexBetterAuthProvider>
        );
      };
    }
    ```

    Wrap each React component that Astro hydrates with `withConvexProvider`.
  </div>

  <div className="fd-step">
    ### Svelte (optional)

    Set up Convex once near the root so Svelte components share the client.

    ```svelte title="src/lib/auth-client.svelte"
    <script lang="ts">
      import { setupConvex } from "convex-svelte";

      // Call this once near the root so children can use Convex hooks
      setupConvex(import.meta.env.PUBLIC_CONVEX_URL as string);
    </script>

    <slot />
    ```

    ```svelte title="src/lib/svelte-convex.svelte"
    <script lang="ts">
      import { setupConvex } from "convex-svelte";

      // Call this once near the root so children can use Convex hooks
      setupConvex(import.meta.env.PUBLIC_CONVEX_URL as string);
    </script>

    <slot />
    ```

    Wrap your Astro layout (or the top-level Svelte entry point) with `svelte-convex`.
  </div>
</div>

## Server helpers (middleware, actions, Convex access)

Share auth helpers across middleware, actions, and Convex functions so you only initialize Better Auth once.

<div className="fd-steps">

  <div className="fd-step">
    ### Bind server helpers

    ```ts title="src/lib/auth-server.ts"
    import { createAstroAuthHelpers } from "@ryantamulevicz/convex-better-auth-astro";
    import { createAuth } from "../convex/auth";

    const { getToken, getAuth, setupFetchClient } = createAstroAuthHelpers(createAuth);

    export { getToken, getAuth, setupFetchClient };
    ```
  </div>

  <div className="fd-step">
    ### Populate middleware context

    ```ts title="src/middleware.ts"
    import { defineMiddleware } from "astro:middleware";
    import { fetchSession } from "@ryantamulevicz/convex-better-auth-astro";
    import { getToken } from "$lib/auth-server";

    const convexSiteUrl = import.meta.env.PUBLIC_CONVEX_SITE_URL;

    export const onRequest = defineMiddleware(async (context, next) => {
      try {
        const token = getToken(context);
        const { session } = await fetchSession(
          context.request,
          convexSiteUrl ? { convexSiteUrl } : undefined,
        );
        context.locals.user = session?.user ?? null;
        context.locals.session = session?.session ?? null;
        context.locals.convexToken = token ?? null;
      } catch {
        context.locals.user = null;
        context.locals.session = null;
        context.locals.convexToken = null;
      }

      return next();
    });
    ```
  </div>

  <div className="fd-step">
    ### Call Convex from actions

    ```ts title="src/actions/update-username.ts"
    import { defineAction } from "astro:actions";
    import { z } from "astro:schema";
    import { api } from "../convex/_generated/api";
    import { setupFetchClient } from "$lib/auth-server";

    export const updateUsername = defineAction({
      input: z.object({ name: z.string() }),
      handler: async (input, context) => {
        const convex = await setupFetchClient(context, {
          convexUrl: import.meta.env.PUBLIC_CONVEX_URL as string,
        });
        await convex.fetchMutation(api.users.updateUsername, {
          username: input.name,
        });
        return { success: true };
      },
    });
    ```

    Call the action from your islands with `actions.updateUsername({ name })`.
  </div>

  <div className="fd-step">
    ### Reuse Better Auth inside Convex

    ```ts title="convex/users.ts"
    import { mutation } from "./_generated/server";
    import { v } from "convex/values";
    import { createAuth, authComponent } from "./auth";

    export const updateUsername = mutation({
      args: { username: v.string() },
      handler: async (ctx, args) => {
        const { auth, headers } = await authComponent.getAuth(createAuth, ctx);
        await auth.api.updateUser({
          body: { name: args.username },
          headers,
        });
      },
    });
    ```
  </div>
</div>

These helpers keep middleware, Astro actions, and Convex functions in sync so Better Auth can serve both client and server code without duplicate wiring.
